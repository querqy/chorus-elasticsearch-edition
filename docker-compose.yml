version: '3.7'
services:
  mysql:
    container_name: mysql
    image: amd64/mysql:5.7.42
    ports:
      - 3306:3306
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=smui
    volumes:
      - ./mysql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql

  opensearch:
    container_name: opensearch
    build: ./opensearch/.
    environment:
      discovery.type: single-node
      node.name: opensearch
      plugins.security.disabled: "true"
#      See https://forum.opensearch.org/t/how-to-enable-cors-cross-origin-resource-sharing/426/3 for more
      http.cors.enabled: true 
#      Warning: this is opening it up to all cross domains
#      http.cors.allow-origin: "http://localhost"...
      http.cors.allow-origin: "*"
      http.cors.allow-methods: OPTIONS,HEAD,GET,POST,PUT,DELETE
      http.cors.allow-credentials: true
      http.cors.allow-headers: X-Requested-With,X-Auth-Token,Content-Type,Content-Length,Authorization
    ulimits:
      memlock:
        soft: -1
        hard: -1
    #volumes:
    #  - ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    #  - es_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
    healthcheck:
      test: [ "CMD", "wget", "http://localhost:9200" ]
      interval: 30s
      timeout: 10s
      retries: 50

  opensearch-dashboards:
    build: ./opensearch-dashboards/.
    container_name: opensearch-dashboards
    ports:
      - 5601:5601
    expose:
      - 5601
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch:9200"]'
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: true
    depends_on:
      - opensearch

  chorus-ui:
    container_name: chorus_ui
    build: ./reactivesearch/.
    volumes:
      - './reactivesearch:/usr/src/app'
      - '/usr/src/app/node_modules'
    ports:
      - 4000:3000

  quepid:
    container_name: quepid
    image: o19s/quepid:6.14.0
    ports:
      - 3000:3000
    environment:
      - PORT=3000
      - RACK_ENV=production
      - RAILS_ENV=production
      - DATABASE_URL=mysql2://root:${MYSQL_ROOT_PASSWORD}@mysql:3306/quepid
      - REDIS_URL=redis://redis:6379/1
      - FORCE_SSL=false
      - MAX_THREADS=2
      - WEB_CONCURRENCY=2
      - RAILS_LOG_TO_STDOUT=true
      - RAILS_SERVE_STATIC_FILES=true
      - SECRET_KEY_BASE=chorus_key
      - TC_URL=
      - PRIVACY_URL=
      - COOKIES_URL=
      - EMAIL_MARKETING_MODE=false
      - EMAIL_PROVIDER=
      - QUEPID_DEFAULT_SCORER=DCG@10
      - SIGNUP_ENABLED=true
    links:
      - mysql
      - redis

  redis:
    container_name: quepid_redis
    image: redis:7.0.11-alpine
    ports:
      - 6379:6379

  smui:
    container_name: smui
    build: ./smui
    ports:
      - 9000:9000
    init: true
    environment:
      - SMUI_HEADLINE=Chorus SMUI
      - SMUI_DB_URL=jdbc:mysql://mysql:3306/smui?autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      - SMUI_DB_USER=root
      - SMUI_DB_PASSWORD=${SMUI_DB_PASSWORD}
      - SMUI_DEPLOY_PRELIVE_SOLR_HOST=opensearch:9200
      - SMUI_TOGGLE_UI_WITH_SOLR_FIELDS=false
      - SMUI_2SOLR_SOLR_HOST=opensearch:9200
      - SMUI_TOGGLE_DEPL_PRELIVE=true
      - SMUI_TOGGLE_SPELLING=true
      - SMUI_TOGGLE_DEPL_CUSTOM_SCRIPT=true
      - SMUI_TOGGLE_DEPL_CUSTOM_SCRIPT_PATH=/smui/conf/smui2es.sh
      - SMUI_DEPLOY_PRELIVE_FN_RULES_TXT=/configs/ecommerce/rules.txt
      - SMUI_DEPLOY_PRELIVE_FN_REPLACE_TXT=/configs/ecommerce/replace-rules.txt
      - SMUI_TOGGLE_RULE_ID_LOGGING=true
      - SMUI_TOGGLE_EVENTHISTORY=true
      - SMUI_RULE_TAGGING_ACTIVE=true
      - SMUI_PREDEFINED_TAGS_FILE=/smui/conf/predefined_tags.json
    depends_on:
      - mysql

volumes:
  mysql_data: {}
  es_data: {}
